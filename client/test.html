<html>

<head>
  <title>Controller Test</title>
  <script type="text/javascript" src="js/jquery.min.js" charset="utf-8"></script>
</head>

<body>
  <h1>Simple Remote Controller Test</h1>
  <p>Latency: <span id="latency">-1</span>ms</p>
  <p>Loop Latency: <span id="looplatency">-1</span>ms</p>
  <script>
    const ws = new WebSocket(`ws://${location.hostname}:8080`)
    ws.onmessage = (event) => {
      if (typeof event.data != 'string') {
        console.log("Unknown data")
        return false
      }

      const data = event.data.split(' ')
      const cmd = data.shift()

      if (cmd == "hb") {
        $("#latency").html(data[1])
        ws.send(`hb ${data[0]}`)
      }
    }

    let lastTimestamp = 0
    let controllerLastTimestamp = 0
    function mainLoop(timestamp) {
      const gp = navigator.getGamepads()[0]
      if (gp != null && gp.timestamp != controllerLastTimestamp) {

        let controls = {
          "roll": 0, 
          "pitch": 0, 
          "yaw": gp.axes[2], 
          "ascend": gp.axes[3], 
          "forward": gp.axes[1], 
          "lateral": gp.axes[0],
          "arm": gp.buttons[9].value,
          "disarm": gp.buttons[8].value,
          "toggleArm": 0,
          "cameraTiltUp": gp.buttons[5].value,
          "cameraTiltDown": gp.buttons[4].value,
          "cameraCenter": gp.buttons[10].value,
          "gainIncrease": gp.buttons[12].value,
          "gainDecrease": gp.buttons[13].value,
          "gripperClose": gp.buttons[6].value,
          "gripperOpen": gp.buttons[7].value,
          "lightsDimBrighter": gp.buttons[15].value,
          "lightsDimDarker": gp.buttons[14].value,
          "depthHoldEnable": 0,
          "depthHoldDisable": 0,
          "depthHoldToggle": gp.buttons[2].value,
          "headingHoldEnable": 0,
          "headingHoldDisable": 0,
          "headingHoldToggle": gp.buttons[3].value,
          "trimRollLeft": 0,
          "trimRollRight": 0
        }

        ws.send(`controls ${JSON.stringify(controls)}`)

        controllerLastTimestamp = gp.timestamp
      }

      $("#looplatency").html(Math.round(timestamp - lastTimestamp))

      lastTimestamp = timestamp
      window.requestAnimationFrame(mainLoop)
    }

    window.requestAnimationFrame(mainLoop)

  </script>
</body>

</html>